### use `&`, `|`, `~` for logical operations on numpy arrays
### can use functions from `math`, `np` (numpy), and `ak` in the expression

## Note: hww has fake fj_isQCD=1.. However in below selection we do not select label_H_wwunmatch in training pool
## attention: change fj_label to fj_label_noH in the selection and 28-32 is QCD labels
## Question: remove (event_no%7!=0) from the selection?
selection: >-
    (jet_tightId==1) & (jet_no<2) & (fj_pt>200) & (fj_pt<2500) & (fj_sdmass>=20) & (fj_sdmass<260) &
    (
      ( (fj_label >= 309) & (fj_label < 314) & (sample_isQCD==1) & (event_no%7!=0) ) |
      ( (fj_label <= 45) & (sample_isQCD==0)  & (event_no%7!=0) )
    )
### selection to apply at test time (i.e., when running w/ --predict)
# starting from v8: we have dedicated QCD and ttbar dataset for test only - they compose of 1/7 full events.
# for QCD: just use 1/2 of events
# Question: Is this test_time_selection only for the test running round? or for the training as well?
test_time_selection: >-
    (jet_tightId==1) & (jet_no<2) &
    (
      ((sample_isQCD==1) & (event_no%2==0)) |
      (sample_isQCD==0)
    )
new_variables:
    ### [format] name: formula
    ### can use functions from `math`, `np` (numpy), and `ak` in the expression
    # attention: add new fj_label_noH for the new labels
    # fj_lable_noH is for the case when we don't have Higgs in the sample to skip the Higgs labels
    # the new lable list(with Higgs) is ['Top_bWcs', 'Top_bWqq', 'Top_bWc', 'Top_bWs', 'Top_bWq', 'Top_bWev', 'Top_bWmv', 'Top_bWtauev', 'Top_bWtaumv', 'Top_bWtauhv', 'Top_Wcs', 'Top_Wqq', 'Top_Wev', 'Top_Wmv', 'Top_Wtauev', 'Top_Wtaumv', 'Top_Wtauhv','H_bb', 'H_cc', 'H_ss', 'H_qq', 'H_bc', 'H_bs', 'H_cs', 'H_gg', 'H_ee', 'H_mm', 'H_tauhtaue', 'H_tauhtaum', 'H_tauhtauh', 'W_cs', 'W_qq', 'W_ev', 'W_mv', 'W_tauev', 'W_taumv', 'W_tauhv', 'Z_bb', 'Z_cc', 'Z_ss', 'Z_qq', 'QCD_bb', 'QCD_cc', 'QCD_b', 'QCD_c', 'QCD_others'] len is 46
    # 46 - 13 = 33, so the new label list(without Higgs) is ['Top_bWcs', 'Top_bWqq', 'Top_bWc', 'Top_bWs', 'Top_bWq', 'Top_bWev', 'Top_bWmv', 'Top_bWtauev', 'Top_bWtaumv', 'Top_bWtauhv', 'Top_Wcs', 'Top_Wqq', 'Top_Wev', 'Top_Wmv', 'Top_Wtauev', 'Top_Wtaumv', 'Top_Wtauhv', 'W_cs', 'W_qq', 'W_ev', 'W_mv', 'W_tauev', 'W_taumv', 'W_tauhv', 'Z_bb', 'Z_cc', 'Z_ss', 'Z_qq', 'QCD_bb', 'QCD_cc', 'QCD_b', 'QCD_c', 'QCD_others'] len is 33
    # 309 - 281 = 28
    fj_label_modified_QCD: ak.where(fj_label>=309, fj_label-281+13, fj_label)
    # since old QCD label is from 309 to 314, we need to change it to 28-32
    # since w semi-leptonice label is absent in the new label list, we need to remove
    fj_label_modified_WSL: ak.where(fj_label_modified_QCD>=12, fj_label_modified_QCD-5, fj_label_modified_QCD)
    # label len is 46, 0-45, Higgs related index start from 17, Higgs related index end at 29, total 13 Higgs related labels
    # so final label is 33, 0-32
    fj_label_noH: ak.where(fj_label_modified_WSL>=17, fj_label_modified_WSL-13, fj_label_modified_WSL)
    
    # after removing Higgs related labels, the label len is 33, 0-32
    label_Top_bWcs: (fj_label_noH == 0)
    label_Top_bWqq: (fj_label_noH == 1)
    label_Top_bWc: (fj_label_noH == 2)
    label_Top_bWs: (fj_label_noH == 3)
    label_Top_bWq: (fj_label_noH == 4)
    label_Top_bWev: (fj_label_noH == 5)
    label_Top_bWmv: (fj_label_noH == 6)
    label_Top_bWtauev: (fj_label_noH == 7)
    label_Top_bWtaumv: (fj_label_noH == 8)
    label_Top_bWtauhv: (fj_label_noH == 9)
    label_Top_Wcs: (fj_label_noH == 10)
    label_Top_Wqq: (fj_label_noH == 11)
    label_W_cs: (fj_label_noH == 12)
    label_W_qq: (fj_label_noH == 13)
    label_W_ev: (fj_label_noH == 14)
    label_W_mv: (fj_label_noH == 15)
    label_W_tauev: (fj_label_noH == 16)
    label_W_taumv: (fj_label_noH == 17)
    label_W_tauhv: (fj_label_noH == 18)
    label_Z_bb: (fj_label_noH == 19)
    label_Z_cc: (fj_label_noH == 20)
    label_Z_ss: (fj_label_noH == 21)
    label_Z_qq: (fj_label_noH == 22)
    label_QCD_bb: (fj_label_noH == 23)
    label_QCD_cc: (fj_label_noH == 24)
    label_QCD_b: (fj_label_noH == 25)
    label_QCD_c: (fj_label_noH == 26)
    label_QCD_others: (fj_label_noH == 27)
    # ordered by pt
    cpfcandlt_index: ak.argsort(cpfcandlt_pt_nopuppi, axis=-1, ascending=False)
    cpfcandlt_pt_log_nopuppi_sort: cpfcandlt_pt_log_nopuppi[cpfcandlt_index]
    cpfcandlt_e_log_nopuppi_sort: cpfcandlt_e_log_nopuppi[cpfcandlt_index]
    cpfcandlt_etarel_sort: cpfcandlt_etarel[cpfcandlt_index]
    cpfcandlt_phirel_sort: cpfcandlt_phirel[cpfcandlt_index]
    cpfcandlt_abseta_sort: cpfcandlt_abseta[cpfcandlt_index]
    cpfcandlt_charge_sort: cpfcandlt_charge[cpfcandlt_index]
    cpfcandlt_isEl_sort: cpfcandlt_isEl[cpfcandlt_index]
    cpfcandlt_isMu_sort: cpfcandlt_isMu[cpfcandlt_index]
    cpfcandlt_isChargedHad_sort: cpfcandlt_isChargedHad[cpfcandlt_index]
    cpfcandlt_isLostTrack_sort: cpfcandlt_isLostTrack[cpfcandlt_index]
    cpfcandlt_VTX_ass_sort: cpfcandlt_VTX_ass[cpfcandlt_index]
    cpfcandlt_lostInnerHits_sort: cpfcandlt_lostInnerHits[cpfcandlt_index]
    cpfcandlt_normchi2_sort: cpfcandlt_normchi2[cpfcandlt_index]
    cpfcandlt_quality_sort: cpfcandlt_quality[cpfcandlt_index]
    cpfcandlt_dz_sort: cpfcandlt_dz[cpfcandlt_index]
    cpfcandlt_dzsig_sort: cpfcandlt_dzsig[cpfcandlt_index]
    cpfcandlt_dxy_sort: cpfcandlt_dxy[cpfcandlt_index]
    cpfcandlt_dxysig_sort: cpfcandlt_dxysig[cpfcandlt_index]
    cpfcandlt_btagEtaRel_sort: cpfcandlt_btagEtaRel[cpfcandlt_index]
    cpfcandlt_btagPtRatio_sort: cpfcandlt_btagPtRatio[cpfcandlt_index]
    cpfcandlt_btagPParRatio_sort: cpfcandlt_btagPParRatio[cpfcandlt_index]
    cpfcandlt_btagSip3dVal_sort: cpfcandlt_btagSip3dVal[cpfcandlt_index]
    cpfcandlt_btagSip3dSig_sort: cpfcandlt_btagSip3dSig[cpfcandlt_index]
    cpfcandlt_btagJetDistVal_sort: cpfcandlt_btagJetDistVal[cpfcandlt_index]
    cpfcandlt_pixelBarrelLayersWithMeasurement_sort: cpfcandlt_pixelBarrelLayersWithMeasurement[cpfcandlt_index]
    cpfcandlt_pixelEndcapLayersWithMeasurement_sort: cpfcandlt_pixelEndcapLayersWithMeasurement[cpfcandlt_index]
    cpfcandlt_stripTECLayersWithMeasurement_sort: cpfcandlt_stripTECLayersWithMeasurement[cpfcandlt_index]
    cpfcandlt_stripTIBLayersWithMeasurement_sort: cpfcandlt_stripTIBLayersWithMeasurement[cpfcandlt_index]
    cpfcandlt_stripTIDLayersWithMeasurement_sort: cpfcandlt_stripTIDLayersWithMeasurement[cpfcandlt_index]
    cpfcandlt_stripTOBLayersWithMeasurement_sort: cpfcandlt_stripTOBLayersWithMeasurement[cpfcandlt_index]
    cpfcandlt_px_sort: cpfcandlt_px[cpfcandlt_index]
    cpfcandlt_py_sort: cpfcandlt_py[cpfcandlt_index]
    cpfcandlt_pz_sort: cpfcandlt_pz[cpfcandlt_index]
    cpfcandlt_energy_sort: cpfcandlt_energy[cpfcandlt_index]
    # masks
    cpfcandlt_mask: ak.ones_like(cpfcandlt_etarel)
    npfcand_mask: ak.ones_like(npfcand_etarel)
    sv_mask: ak.ones_like(sv_etarel)

preprocess:
    ### method: [manual, auto] - whether to use manually specified parameters for variable standardization
    method: manual
    ### data_fraction: fraction of events to use when calculating the mean/scale for the standardization
    data_fraction:

inputs:
    cpf_features:
        length: 90
        pad_mode: wrap
        vars:
            ### [format 1]: var_name (no transformation)
            ### [format 2]: [var_name,
            ###              subtract_by(optional, default=None, no transf. if preprocess.method=manual, auto transf. if preprocess.method=auto),
            ###              multiply_by(optional, default=1),
            ###              clip_min(optional, default=-5),
            ###              clip_max(optional, default=5),
            ###              pad_value(optional, default=0)]
            - [cpfcandlt_pt_log_nopuppi_sort, 1, 0.5]
            - [cpfcandlt_e_log_nopuppi_sort, 1.3, 0.5]
            - cpfcandlt_etarel_sort
            - cpfcandlt_phirel_sort
            - [cpfcandlt_abseta_sort, 0.6, 1.6]
            - cpfcandlt_charge_sort
            - cpfcandlt_isEl_sort
            - cpfcandlt_isMu_sort
            - cpfcandlt_isChargedHad_sort
            - cpfcandlt_isLostTrack_sort
            - [cpfcandlt_VTX_ass_sort, 4, 0.3]
            - cpfcandlt_lostInnerHits_sort
            - [cpfcandlt_normchi2_sort, 5, 0.2]
            - [cpfcandlt_quality_sort, 0, 0.2]
            - [cpfcandlt_dz_sort, 0, 180]
            - [cpfcandlt_dzsig_sort, 0, 0.9]
            - [cpfcandlt_dxy_sort, 0.0, 300]
            - [cpfcandlt_dxysig_sort, 0, 1.0]
            - [cpfcandlt_btagEtaRel_sort, 1.5, 0.5]
            - [cpfcandlt_btagPtRatio_sort, 0, 1]
            - [cpfcandlt_btagPParRatio_sort, 0, 1]
            - [cpfcandlt_btagSip3dVal_sort, 0, 100]
            - [cpfcandlt_btagSip3dSig_sort, 0, 0.5]
            - [cpfcandlt_btagJetDistVal_sort, 0, 40]
            - [cpfcandlt_pixelBarrelLayersWithMeasurement_sort, 0, 0.1]
            - [cpfcandlt_pixelEndcapLayersWithMeasurement_sort, 0, 0.1]
            - [cpfcandlt_stripTECLayersWithMeasurement_sort, 0, 0.1]
            - [cpfcandlt_stripTIBLayersWithMeasurement_sort, 0, 0.1]
            - [cpfcandlt_stripTIDLayersWithMeasurement_sort, 0, 0.1]
            - [cpfcandlt_stripTOBLayersWithMeasurement_sort, 0, 0.1]
    cpf_vectors:
        length: 90
        pad_mode: wrap
        vars:
            - [cpfcandlt_px_sort, null]
            - [cpfcandlt_py_sort, null]
            - [cpfcandlt_pz_sort, null]
            - [cpfcandlt_energy_sort, null]
    cpf_mask:
        length: 90
        pad_mode: constant
        vars:
            - cpfcandlt_mask
    npf_features:
        length: 60
        pad_mode: wrap
        vars:
            - [npfcand_pt_log_nopuppi, 1, 0.5]
            - [npfcand_e_log_nopuppi, 1.3, 0.5]
            - npfcand_etarel
            - npfcand_phirel
            - [npfcand_abseta, 0.6, 1.6]
            - npfcand_isGamma
            - npfcand_isNeutralHad
    npf_vectors:
        length: 60
        pad_mode: wrap
        vars:
            - [npfcand_px, null]
            - [npfcand_py, null]
            - [npfcand_pz, null]
            - [npfcand_energy, null]
    npf_mask:
        length: 60
        pad_mode: constant
        vars:
            - npfcand_mask
    sv_features:
        length: 10
        pad_mode: wrap
        vars:
            - [sv_pt_log, 4, 0.6]
            - [sv_mass, 1.2, 0.3]
            - sv_etarel
            - sv_phirel
            - [sv_abseta, 0.5, 1.6]
            - [sv_ntracks, 3, 1]
            - [sv_normchi2, 0.8, 0.6]
            - [sv_dxy, 0.4, 0.25]
            - [sv_dxysig, 7, 0.02]
            - [sv_d3d, 0.5, 0.2]
            - [sv_d3dsig, 7, 0.02]
    sv_vectors:
        length: 10
        pad_mode: wrap
        vars:
            - [sv_px, null]
            - [sv_py, null]
            - [sv_pz, null]
            - [sv_energy, null]
    sv_mask:
        length: 10
        pad_mode: constant
        vars:
            - sv_mask

labels:
    ### type can be `simple`, `custom`, 'hybrid'
    type: simple
    value: null
    # attention: add new label index for the new labels
    value_cls_index: fj_label_noH  # just input the label index
    # attention: add new label classes
    value_cls_names: ['Top_bWcs', 'Top_bWqq', 'Top_bWc', 'Top_bWs', 'Top_bWq', 'Top_bWev', 'Top_bWmv', 'Top_bWtauev', 'Top_bWtaumv', 'Top_bWtauhv', 'Top_Wcs', 'Top_Wqq', 'Top_Wev', 'Top_Wmv', 'Top_Wtauev', 'Top_Wtaumv', 'Top_Wtauhv', 'W_cs', 'W_qq', 'Z_bb', 'Z_cc', 'Z_ss', 'Z_qq', 'QCD_bb', 'QCD_cc', 'QCD_b', 'QCD_c', 'QCD_others']
    value_custom:

observers:
    - event_no
    - fj_label
    - fj_pt
    - fj_eta
    - fj_phi
    - fj_mass
    - fj_sdmass
    - fj_sdmass_fromsubjets
    - fj_gen_mass
    - fj_genparts_mass
    - fj_genjet_sdmass
    - fj_genjet_nomu_sdmass
    - sample_isQCD
    # attention: add new observers as non-MD particle-net TvsQCD and WvsQCD
    # Question: any others particle-net observers we need to add?
    - pfParticleNetDiscriminatorsJetTags_ZvsQCD
    - pfParticleNetDiscriminatorsJetTags_TvsQCD
    - pfParticleNetDiscriminatorsJetTags_WvsQCD
    - pfParticleNetJetTags_probHbb
    - pfParticleNetJetTags_probHcc
    - pfParticleNetJetTags_probHqqqq
    - pfParticleNetJetTags_probQCDb
    - pfParticleNetJetTags_probQCDbb
    - pfParticleNetJetTags_probQCDc
    - pfParticleNetJetTags_probQCDcc
    - pfParticleNetJetTags_probQCDothers
    - pfParticleNetJetTags_probTbc
    - pfParticleNetJetTags_probTbcq
    - pfParticleNetJetTags_probTbel
    - pfParticleNetJetTags_probTbmu
    - pfParticleNetJetTags_probTbq
    - pfParticleNetJetTags_probTbqq
    - pfParticleNetJetTags_probTbta
    - pfParticleNetJetTags_probWcq
    - pfParticleNetJetTags_probWqq
    - pfParticleNetJetTags_probZbb
    - pfParticleNetJetTags_probZcc
    - pfParticleNetJetTags_probZqq
    # attention: change the transformers observers based on the new labels
    # ['Top_bWcs', 'Top_bWqq', 'Top_bWc', 'Top_bWs', 'Top_bWq', 'Top_bWev', 'Top_bWmv', 'Top_bWtauev', 'Top_bWtaumv', 'Top_bWtauhv', 'Top_Wcs', 'Top_Wqq', 'Top_Wev', 'Top_Wmv', 'Top_Wtauev', 'Top_Wtaumv', 'Top_Wtauhv', 'W_cs', 'W_qq', 'W_ev', 'W_mv', 'W_tauev', 'W_taumv', 'W_tauhv', 'Z_bb', 'Z_cc', 'Z_ss', 'Z_qq', 'QCD_bb', 'QCD_cc', 'QCD_b', 'QCD_c', 'QCD_others']

weights:
    use_precomputed_weights: false
    reweight_method: flat
    reweight_vars:
        fj_pt:
            - 200
            - 251
            - 316
            - 398
            - 501
            - 630
            - 793
            - 997
            - 1255
            - 1579
            - 1987
            - 2500
        # attention: change fj_sdmass from bin to -inf to inf
        fj_sdmass:
            - -99999
            - 99999
    reweight_classes:
        - fj_isQCD
        - fj_isTop
        - fj_isW
        - fj_isZ
    # attention: change class_weights to all be 1
    class_weights:
        - 1
        - 1
        - 1
        - 1
    reweight_hists: